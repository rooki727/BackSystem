<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>人脸识别注册</title>
   <link rel="stylesheet" href="./css/faceregister.css">
</head>

<body>
 <!-- 撑开页面 -->
 <img src="./imgae/backgroundimglogin2.png" alt="">
 <div class="container">
   <h1>人脸识别注册</h1>
   <video id="video" width="640" height="480" autoplay></video>
   <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
   <br>
   <input type="text" placeholder="请输入用户名：" id="username">
 <br>
  <button id="captureButton">开始发送人脸</button>
   <button id="faceregister">注册人脸</button>
 <br>
   <a href="register.html">以其他方式注册</a>
   <a href="facelogin.html">已注册人脸，前往人脸登陆</a>
   </div>

 <script src="js/jquery-3.7.1.js"></script>
 <script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const captureButton = document.getElementById('captureButton');
  const username = document.querySelector('#username')
  const faceregister = document.querySelector('#faceregister')

  // 禁用第二个按钮
  faceregister.disabled = true;

  let captureCount = 0;
  navigator.mediaDevices.getUserMedia({ video: true })
          .then((stream) => {
            video.srcObject = stream;
          })
          .catch((error) => {
            console.error('Error accessing camera: ', error);
          });

  captureButton.addEventListener('click', () => {
    captureImage();
    startCountdown()
  });

  function startCountdown() {
    var countdown = 5; // 设置倒计时时间，单位为秒

    // 每秒更新倒计时时间，并在时间结束后显示第二个按钮
    var countdownInterval = setInterval(function () {
      faceregister.innerHTML = "倒计时: " + countdown;
      countdown--;

      if (countdown < 0) {
        clearInterval(countdownInterval);
        faceregister.innerHTML = "注册人脸";
        faceregister.disabled = false;
      }
    }, 1000);
  }

  function captureImage() {
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageDataUrl = canvas.toDataURL('image/jpg');

    // Send imageDataUrl to the server using AJAX or other methods
    // Example: Send data to a servlet using XMLHttpRequest
    const xhr = new XMLHttpRequest();
    xhr.open('POST', 'faceregisterServlet', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onreadystatechange = function () {
      if (xhr.readyState == 4 && xhr.status == 200) {
        console.log('Image sent successfully');
      }
    };
    const combinedData = 'imageData=' + encodeURIComponent(imageDataUrl) + '&username=' + encodeURIComponent(username.value);
    xhr.send(combinedData);
    // xhr.send('imageData=' + encodeURIComponent(imageDataUrl));
    captureCount++;
    if (captureCount < 60) {
      setTimeout(captureImage, 100); // 继续截取图片，每隔200ms执行一次
    }
  }

  //验证人脸注册按钮
  faceregister.addEventListener('click', function () {
    console.log(111);
    $.ajax({
      url: "FaceRegisterHttp",
      method: "POST",
      data: {
        action: "faceregister",

      },
      success: function (data) {
        if (data === "successregister") {
          alert('注册成功！即将跳转登陆页面!')
          location.href = "facelogin.html"
        }
        else {
          alert('注册失败!请重试注册或者以其他方式注册！')
        }
      },
      error: function () {
        console.log("AJAX请求出错");
      }
    });
  })
</script>
</body>

</html>